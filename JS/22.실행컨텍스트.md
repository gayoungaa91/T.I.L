## 실행 컨텍스트(Execution Context)

![image-20190930200648785](/Users/igayeong/Library/Application Support/typora-user-images/image-20190930200648785.png)

### 실행 가능한 코드의 평가와 실행

- 코드의 평가 과정에서 실행 컨텍스트가 생성되고 변수, 함수, 클래스 등의 선언문이 평가되어 실행컨텍스트에 등록된다.
- 코드가 실행되면 필요한 정보는 실행콘텍스트에서 가져올 수 있으며 , 실행 결과 또한 실행 컨텍스트에서 관리된다.
![image-20190930201654281](/Users/igayeong/Library/Application Support/typora-user-images/image-20190930201654281.png)



### 실행콘텍스트의 역할
##### 1.  전역코드 평가
- 전역 변수와 전역함수는 전역 스코프에 등록된다.
	var 키워드로 선언된 전역변수와 전역함수는 전역 객체의 프로퍼티가 된다.
##### 2. 전역코드 실행

- 	전역 코드 평가가 종료되면 순차적으로 전역 코드가 실행되어 전역 변수에 값이 할당되고 함수가 호출된다.
- 	함수가 호출되면 순차적으로 실행되던 전역 코드의 실행을 일시 중단하고 코드 실행 순서를 변경하여 함수 내부로 진입한다.

##### 3. 함수 코드 평가

- 매개변수와 지역변수는 지역스코프에 등록된다.
-  arguments객체도 지역스코프에 등록된다.

##### 4. 함수 코드 실행

- ㅇconsole.log를 호출하기 위해서는 console을 스코프 체인을 통해 검색한다. 
- 코드를 실행하려면 스코프를 구분하여 식별자와 바인된값을 관리할 수 있어야 한다. 
- 스코프, 식별자, 코드 실행 순서등의 관리가 필요 하다.



#### 실행 컨텍스트는 `실행가능한 코드를 평가`하고 `실행하기 위해 필요한 환경을 제공`하고 코드 `실행 결과를 실제로 관리`하는 영역이다.



### 실행 컨텍스트 스택

- Call stack 이라고 부르기도 한다.
- stack 자료구조로 관리된다.



> 스택(stack)

마지막에 넣은 데이터를 먼저 꺼내는 `후입선출`방식의 자료구조다.
스택에서 데이터를 넣는것을 푸시(push)라하고 스택에서 데이터를 꺼내는 것을 팝(pop)이라 한다.



> 큐(queue)

가장 먼저 넣은 데이터를 먼저 꺼내는 `선입선출`방식의 자료구조다.
큐는 데이터를 넣은 순서대로 취득한다.



```
const x = 1;

function foo () {
  const y = 2;

  function bar () {
    const z = 3;
    console.log(x + y + z);
  }
  bar();
}

foo(); // 6
```

![image-20191015210606635](/Users/igayeong/Library/Application Support/typora-user-images/image-20191015210606635.png)

##### 1. 전역코드의 평가와 실행

 1. 전역코드를 평가하여, 전역 실행 컨텍스트 생성를 생성하고 실행컨텍스트 스택에 푸쉬
  2. 전역변수 x와 전역함수 foo는 전역 실행컨텍스트에 등록
    3. 코드가 실행되며, 전역변수 x의 값이 할당되고 전역함수 foo가 호출

##### 2. 함수 코드의 평가와 실행
1. 전역함수 foo가 호출되면 전역코드의 실행은 일시 중단되고 foo함수 내부로 이동한다.
2. 자바스크립트 엔진은 foo함수의 내부 함수 코드를 평가하여 foo함수 실행 컨텍스트를 생성하고 실행 컨텍스트 스택에 푸시
3. foo의 지역변수 y와 중첩함수 bar가 foo 함수 실행 컨텍스트에 등록된다. 
4. foo 함수 코드가 실행되며 y에 값에 할당되고 bar가 호출된다.
##### 3. bar 함수 코드의 평가와 실행

1. 중첩함수 bar가 호출되면 함수 foo의 코드 실행은 일시 중단되고 bar함수 내부로 이동한다.
2. 자바스크립트 엔진은 bar 함수 내부의 함수 코드를 평가하여 bar 함수 실행컨텍스트를 생성하고 실행 컨텍스트 스택에 푸시한다.
3. bar함수의 지역변수 z가 bar 함수 실행 컨텍스트에 등록된다.
4. bar 함수 코드가 실행되며 지역변수 z에 값이 할당되고 console.log메소드를 호출한후 함수 bar는 종료된다.

##### 4. foo 함수 코드로 복귀

1. 함수 bar가 종류되면 다시 함수 foo로 이동한다. 
2. 자바스크립트 엔진은 bar 함수 실행컨텍스트를 실행컨텍스트 스택에서 팝하여 제거한다.
3. 그리고 함수 foo는 종료된다.

##### 5. 전역코드로 복귀

1. 함수 foo가 종료되면 다시 전역 코드로 이동한다.
2. 자바스크립트 엔진은 foo 함수 실행 컨텍스트를 실행컨텍스트 스택에서 팝하여 제거한다.
3. 전역 실행 컨텍스토도 씰행 컨텍스트 스택에서 팝되고, 실행컨텍스트 스택에는 아무것도 남아있지 않게된다.



- 실행 컨텍스트 스택은 코드의 실행 순서를 관리한다.
	1. 실행 가능한 코드가 평가되면
  2. 실행컨텍스트가 생성되고
  3. 실행컨텍스트 스택에 최상위에 쌓인다.
- 실행 컨텍스트의 최상위 실행 컨텍스트는 언제나 현재 실행중인 실행 컨텍스트이다. `실행중인 실행 컨텍스트(running execution context)`라고 부르기도 한다.
- 실행 가능한 코드가 종료되면 해당 실행컨텍스트는 실행컨텍스트 스택에서 팝되어 제거되고 직전의 실행 컨텍스트 코드로 이동한다.



### 동기식 처리 모델 & 비동기식 처리 모델

- 자바스크립트는 하나의 실행컨텍스트를 갖는 싱글 스레드(single thread) 언어다.
- 최상위 스택만이 현재 실행중인 실행 컨텍스트이며, 나머지는 모두 실행 대기중인 태스크들이다.



#### 동기식 처리모델

- 하나의 처리가 종료되어야 다음 처리를 실행할 수 있는것
- 직렬적으로 테스크(task)를 수행한다.



#### 비동기식 처리모델

- 자바스크립트는 비동기식 처리 모델을 지원한다.
- 병렬적으로 테스크를(task)를 수행한다.
- 자바스크립트의 Timer 함수(setTimeout, setInterval), Ajax 요청은 비동기식 처리 모델로 동작한다.
- 싱글스레드의 약점을 보완해줄 수 있지만, 순차적이지 않은 코드는 가독성이 떨어지고, 콜백헬을 유발할여 에러처리가 어렵다는 단점도 있다.



### 렉시컬 환경(Lexical Environment)

- 식별자가 선언되는 환경을 말한다. 즉 렉시컬 스코프를 의미한다.
- 스코프와 식별자를 관리한다.
- 스코프를 구분하여 식별자를 등록하고 관리하는 저장소 역할을 한다.
  ![하나의 동일한 렉시컬 환경을 참조한다.](/Users/igayeong/Library/Application Support/typora-user-images/image-20191015223333342.png)

> **LexicalEnvironment 컴포넌트와 VariableEnvironment 컴포넌트**

하나의 동일한 렉시컬 환경을 참조한다.
코드 실행되다가 특수한 상황을 만나면 `VariableEnvironment 컴포넌트`를 위한 새로운 렉시컬 환경을 생성하고 이때부터 VariableEnvironment 컴포넌트와 LexicalEnvironment 컴포넌트는 내용이 달라지게 되며 이후 주로 LexicalEnvironment 컴포넌트를 사용한다.



##### 렉시컬 환경의 3가지 컴포넌트

![image-20191015224153033](/Users/igayeong/Library/Application Support/typora-user-images/image-20191015224153033.png)

1. **환경 레코드** : 식별자를 등록하고 등록된 식별자에 바인딩된 값을 관리하는 저장소다.
2. **외부 렉시컬 환경에 대한 참조** : 실행 컨텍스트를 생성한 실행 가능한 코드를 포함하는 상위 코드의 렉시컬 환경을 가리키는 참조를 저장한다. 이를 통해 단방향 링크드 리스트인 스코프 체인을 구현한다.
3. **this 바인딩(This binding)** : 렉시컬 환경의 this에 바인딩된 객체를 나타낸다.



### 실행 컨텍스트의 생성과 식별자 검색 과정

```
var x = 1;
const y = 2;

function foo (a) {
  var x = 3;
  const y = 4;

  function bar (b) {
    const z = 5;
    console.log(a + b + x + y + z);
}
  bar(10);
}

foo(20); // 42
```

#### 1. 전역 객체 생성

- 전역 코드가 평가되기 이전에 생성된다.
- 전역 프로퍼티와 전역함수, 표준 빌트인 객체, 동작 환경에 따라 클라이언트 사이드 Web API(DOM, BOM, Canvas, XMLHttpRequest, Fetch, requestAnimationFrame, SVG, Web Storage, Web Component, Web worker 등)
- 전역객체도 프로토타입 체인의 일원으로 Object.prototype을 상속받는다.

#### 전역 코드 평가

1. 전역 실행 컨텍스트 생성
2. 전역 렉시컬 환경 생성
  2.1. 전역 환경 레코드 생성
    2.1.1. 객체 환경 레코드 생성
    2.1.2. 선언적 환경 레코드 생성
  2.2. 외부 렉시컬 환경에 대한 참조 할당
  2.3. this 바인딩

![image-20191015230621970](/Users/igayeong/Library/Application Support/typora-user-images/image-20191015230621970.png)

##### 1. 전역 실행 컨텍스트 생성
- 전역 실행 컨텍스트를 생성후 실행 컨텍스트 스택에 푸시한다.
- 이때 전역 실행 컨텍스트는 실행 컨텍스트의 최상위, 실행중인 실행 컨텍스트가 된다.
#####2. 전역 렉시컬 환경 생성

- 전역 렉시컬 환경(Global Lexical Environment)을 생성하고 전역 실행 컨텍스트의 LexicalEnvironment 컴포넌트와 VariableEnvironment 컴포넌트에 바인딩한다.
- ![image-20191015231432375](/Users/igayeong/Library/Application Support/typora-user-images/image-20191015231432375.png)

###### 2.1. 전역 환경 레코드 생성

- **객체 환경 레코드 생성** 
  - Var 키워드로 선언된 전역변수와 함수선언문으로 정의된 전역함수가 등록되고 관리된다.

######  선언적 환경 레코드 생성

###### 2.2. 외부 렉시컬 환경에 대한 참조 할당
###### 2.3. this 바인딩













<hr>

###### Reference 
[Poiemaweb]: https://poiemaweb.com